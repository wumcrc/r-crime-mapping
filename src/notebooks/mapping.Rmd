---
title: "Saint Louis City Crime Data - Mapping"
author: "Jes Stevens, M.A."
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output:
  github_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction 

[Washington University Medical Center Redevelopment Corporation](http://wumcrc.com) is a partnership between BJC Health Care and Washington University School of Medicine and works to improve the quality of life for the neighborhoods surrounding the medical campus. In order to achieve this goal in Forest Park Southeast and the Central West End , WUMCRC has invested millions of dollars toward regenerating the market for private investment in businesses and real estate, enhancing human and social service opportunities, and improving the level of physical and personal security.

## Mapping 

One way we work to improve the level of physical & personal security is the analysis and distribution of crime data and statistics. The original source of this crime data is <http://slmpd.org/crimereports.shtml>. This notebook takes the data that was previously cleaned and maps the data.  

## R Markdown

```{r Load Dependencies, include = FALSE, echo = FALSE}
# tidyverse packages
library(ggplot2)      # plotting data

# spatial packages
library(mapview)      # preview spatial data
library(tmap)         # map layouts
library(tmaptools)
library(sf)           # spatial data tools
library(osmdata)
library(ceramic)

# other packages
library(here)         # file path management
library(RColorBrewer) # color palettes
library(viridis)      # color palettes
library(gateway)      # Data from the City of St. Louis
```

## Load Spatial Data 

## Coordinates

```{r}
# Service Area Neighborhood Coordinates 
xyfpse <- c(-90.2679, -90.2423, 38.6176, 38.6334)
xycwe <- c(-90.2759, -90.2368, 38.6286, 38.6552)
xybot <- c(-90.2596, -90.2359, 38.6165, 38.6291)
xydbp <- c(-90.2869, -90.2726, 38.6433, 38.6566)
xysdb <- c(-90.3026, -90.2827, 38.6456, 38.6571)
xywe <- c(-90.3020, -90.2712, 38.6517, 38.6710)
xyvp <- c(-90.2803, -90.2712, 38.6517, 38.6622)
xyac <- c(-90.2744, -90.2609, 38.6505, 38.6661)
xyfp <- c(-90.2648, -90.2543, 38.6493, 38.6655)
xylp <- c(-90.2588, -90.2437, 38.6481, 38.6624)
xyvd <- c(-90.2520, -90.2304, 38.6426, 38.6585)
```


### Open Street Map from Mapbox - Basemap Tile Imagery

```{r}
fpse_tiles <- raster::extent(xyfpse) %>%
  cc_location(., type = "mapbox.streets", max_tiles = 15)

cwe_tiles <- raster::extent(xycwe) %>% 
  cc_location(., type = "mapbox.streets", max_tiles = 15)

bot_tiles <- raster::extent(xybot) %>%
  cc_location(., type = "mapbox.streets", max_tiles = 15)

dbp_tiles <- raster::extent(xydbp) %>% 
  cc_location(., type = "mapbox.streets", max_tiles = 15)

sdb_tiles <- raster::extent(xysdb) %>%
  cc_location(., type = "mapbox.streets", max_tiles = 15)

we_tiles <- raster::extent(xywe) %>% 
  cc_location(., type = "mapbox.streets", max_tiles = 15)

vp_tiles <- raster::extent(xyvp) %>%
  cc_location(., type = "mapbox.streets", max_tiles = 15)

ac_tiles <- raster::extent(xyac) %>% 
  cc_location(., type = "mapbox.streets", max_tiles = 15)

fp_tiles <- raster::extent(xyfp) %>% 
  cc_location(., type = "mapbox.streets", max_tiles = 15)

lp_tiles <- raster::extent(xylp) %>%
  cc_location(., type = "mapbox.streets", max_tiles = 15)

vd_tiles <- raster::extent(xyvd) %>% 
  cc_location(., type = "mapbox.streets", max_tiles = 15)
```

### Spatial Data from the City Of St. Louis

```{r}
nhoods_sf <- gw_get_data("Neighborhoods", "sf")
sa_sf <- nhoods_sf %>% 
  filter(., NHD_NUM %in% sa)
```

## FPSE, BOT, CWE, MC 

### Map Creation

#### FPSE

```{r FPSE Total Crime}
fpse_total <- tm_shape(fpse_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., NHD_NUM == 39) %>% 
  tm_shape() +
    tm_fill(col = "#9ecae1", 
            alpha = .5) +
    tm_borders(col = "black", 
               lwd = 2, 
               lty = "dashed") +
  filter(crimes19_sf, 
         neighborhood == 39) %>%
  tm_shape() +
    tm_bubbles(size = .25, 
               col = "crimeCatName", 
               palette = "Set1", 
               title.col = "Part 1 Crimes") +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white", 
    legend.frame=TRUE,
    legend.outside = FALSE,
    legend.position = c("right", "bottom"))

fpse_total
``` 


```{r FPSE Day & Night}
fpse_dn <- tm_shape(fpse_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., NHD_NUM == 39) %>% 
  tm_shape() +
    tm_fill(col = "#9ecae1", 
            alpha = .5) +
    tm_borders(col = "black", 
               lwd = 2, 
               lty = "dashed") +
  filter(crimes19_sf, 
         neighborhood == 39) %>%
  tm_shape() +
    tm_bubbles(size = .25, 
               col = "dayNight", 
               palette = "-RdBu", 
               title.col = "Time of Crimes") +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white", 
    legend.frame=TRUE,
    legend.outside = FALSE,
    legend.position = c("right", "bottom"))

fpse_dn
```

```{r FPSE Crimes Against Persons}
fpse_vlnt <- tm_shape(fpse_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., NHD_NUM == 39) %>% 
  tm_shape() +
    tm_fill(col = "#9ecae1", 
            alpha = .5) +
    tm_borders(col = "black", 
               lwd = 2, 
               lty = "dashed") +
  filter(crimes19_sf, 
         neighborhood == 39) %>%
  tm_shape() +
    tm_bubbles(size = .25, 
               col = "violent", 
               palette = "Reds", 
               title.col = "Violent") +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white", 
    legend.frame=TRUE,
    legend.outside = FALSE,
    legend.position = c("right", "bottom"))

fpse_vlnt
```

#### CWE

```{r}
# This Code is incomplete

cwe_total <- tm_shape(cwe_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., NHD_NUM == 38) %>% 
  tm_shape() +
    tm_fill(col = "#9ecae1", alpha = .5) +
    tm_borders(col = "black", lwd = 2, lty = "dashed") +
  filter(crimes19_sf, neighborhood == 38) %>%
  tm_shape() +
    tm_bubbles(size = .25, col = "crimeCatName", palette = "Set1")


cwe_total

tmap_save(cwe_total, file = "cwe_total_crimes.jpeg", dpi = 500)
```

### Save Maps

```{r}
tmap_save(fpse_total, file = here("data/results/2019/august/fpse/fpse_total_crimes.jpeg"), dpi = 500)
tmap_save(fpse_dn, file = here("data/results/2019/august/fpse/fpse_day_night.jpeg"), dpi = 500)
tmap_save(fpse_vlnt, file = here("data/results/2019/august/fpse/fpse_vlnt.jpeg"), dpi = 500)
```


